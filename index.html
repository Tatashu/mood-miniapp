<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</title>
  <script src="https://js.telegram.org/bot/api.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #000000);
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 24px;
      text-align: center;
    }
    .mood-circle {
      position: relative;
      width: 200px;
      height: 200px;
      margin: 20px 0;
    }
    .circle-bg {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 8px solid var(--tg-theme-hint-color, #e0e0e0);
    }
    .circle-fill {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      clip-path: polygon(50% 50%, 50% 0%, 100% 0%, 100% 100%, 0% 100%, 0% 0%, 50% 0%);
      background: conic-gradient(
        #4caf50 0%,
        #4caf50 60%,
        #ff9800 60%,
        #ff9800 90%,
        #f44336 90%,
        #f44336 100%
      );
      transform: rotate(-90deg);
    }
    .indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 24px;
      height: 24px;
      background: var(--tg-theme-button-color, #3390ec);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 2;
    }
    .center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 1;
    }
    .emoji {
      font-size: 48px;
      line-height: 1;
      transition: transform 0.2s;
    }
    .value {
      font-size: 14px;
      color: var(--tg-theme-hint-color, #777);
      margin-top: 4px;
    }
    button {
      background: var(--tg-theme-button-color, #3390ec);
      color: var(--tg-theme-button-text-color, #ffffff);
      border: none;
      border-radius: 12px;
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 600;
      margin-top: 16px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .status {
      margin-top: 16px;
      font-size: 14px;
      color: var(--tg-theme-hint-color, #777);
      text-align: center;
      min-height: 1.4em;
    }
  </style>
</head>
<body>
  <div class="title">–ö–∞–∫ —Ç—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å?</div>

  <div class="mood-circle" id="moodCircle">
    <div class="circle-bg"></div>
    <div class="circle-fill" id="circleFill"></div>
    <div class="indicator" id="indicator"></div>
    <div class="center">
      <div class="emoji" id="emoji">üôÇ</div>
      <div class="value" id="value">50</div>
    </div>
  </div>

  <button id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <div class="status" id="status"></div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.expand();
      tg.ready();
    }

    // DOM
    const circle = document.getElementById('moodCircle');
    const indicator = document.getElementById('indicator');
    const emojiEl = document.getElementById('emoji');
    const valueEl = document.getElementById('value');
    const saveBtn = document.getElementById('saveBtn');
    const statusEl = document.getElementById('status');

    let moodValue = 50; // 0‚Äì100

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
    function updateUI() {
      // –ü–æ–∑–∏—Ü–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ (–ø–æ –æ–∫—Ä—É–∂–Ω–æ—Å—Ç–∏)
      const radius = 86; // (200 - 8*2 - 24)/2 ‚âà 86
      const angle = (moodValue / 100) * 2 * Math.PI - Math.PI / 2;
      const x = radius * Math.cos(angle);
      const y = radius * Math.sin(angle);
      indicator.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;

      // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫—Ä—É–≥–∞
      const fillAngle = (moodValue / 100) * 360;
      document.getElementById('circleFill').style.clipPath = 
        `polygon(50% 50%, 50% 0%, ${100}% 0%, ${100}% ${100}%, 0% ${100}%, 0% 0%, 50% 0%)`;

      // –°–º–∞–π–ª–∏–∫ –∏ —Ü–≤–µ—Ç
      if (moodValue <= 30) {
        emojiEl.textContent = 'üòû';
        emojiEl.style.color = '#f44336';
      } else if (moodValue <= 60) {
        emojiEl.textContent = 'üôÇ';
        emojiEl.style.color = '#ff9800';
      } else {
        emojiEl.textContent = 'üòä';
        emojiEl.style.color = '#4caf50';
      }

      valueEl.textContent = moodValue;
    }

    // –†–∞—Å—á—ë—Ç —É–≥–ª–∞ –∏–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
    function getAngleFromTouch(clientX, clientY) {
      const rect = circle.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      const dx = clientX - centerX;
      const dy = clientY - centerY;
      let angle = Math.atan2(dy, dx); // -œÄ –¥–æ +œÄ
      if (angle < -Math.PI / 2) angle += 2 * Math.PI; // —Å–¥–≤–∏–≥–∞–µ–º, —á—Ç–æ–±—ã 0¬∞ –±—ã–ª –≤–≤–µ—Ä—Ö—É
      return angle;
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    function handleMove(e) {
      e.preventDefault();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      let angle = getAngleFromTouch(clientX, clientY);
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —É–≥–æ–ª ‚Üí –∑–Ω–∞—á–µ–Ω–∏–µ 0‚Äì100
      moodValue = Math.round(((angle + Math.PI / 2) / (2 * Math.PI)) * 100);
      if (moodValue < 0) moodValue = 0;
      if (moodValue > 100) moodValue = 100;
      updateUI();
    }

    circle.addEventListener('mousedown', (e) => {
      document.addEventListener('mousemove', handleMove);
      document.addEventListener('mouseup', () => {
        document.removeEventListener('mousemove', handleMove);
      }, { once: true });
      handleMove(e);
    });

    circle.addEventListener('touchstart', (e) => {
      document.addEventListener('touchmove', handleMove, { passive: false });
      document.addEventListener('touchend', () => {
        document.removeEventListener('touchmove', handleMove);
      }, { once: true });
      handleMove(e);
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    updateUI();

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    saveBtn.addEventListener('click', () => {
      const entry = {
        date: new Date().toISOString().split('T')[0],
        mood: moodValue,
        timestamp: Date.now()
      };

      // 1. –í localStorage
      const entries = JSON.parse(localStorage.getItem('mood_entries') || '[]');
      entries.push(entry);
      localStorage.setItem('mood_entries', JSON.stringify(entries));

      // 2. –ë–æ—Ç—É (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
      tg?.sendData(JSON.stringify({ action: 'mood', ...entry }));

      statusEl.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!';
      saveBtn.disabled = true;
      setTimeout(() => {
        statusEl.textContent = '';
        saveBtn.disabled = false;
      }, 2000);
    });
  </script>
</body>
</html>
