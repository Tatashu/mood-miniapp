<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</title>
  <script src="https://js.telegram.org/bot/api.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: var(--tg-theme-bg-color, #ffffff);
      --text: var(--tg-theme-text-color, #000000);
      --hint: var(--tg-theme-hint-color, #94a3b8);
      --subtle: var(--tg-theme-secondary-bg-color, #f1f5f9);
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 24px 16px;
    }
    .title {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 32px;
      text-align: center;
      opacity: 0.9;
    }
    .mood-circle {
      position: relative;
      width: 220px;
      height: 220px;
    }
    .circle-container {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      overflow: hidden;
    }
    .circle-fill {
      width: 100%;
      height: 100%;
      background: conic-gradient(
        from 90deg at 50% 50%,
        /* 0‚Äì19: —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π */
        #8b5cf6 0%,
        #a78bfa 19%,
        /* 20‚Äì59: –ø–µ—Ä–µ—Ö–æ–¥ */
        #a78bfa 20%,
        #60a5fa 35%,
        #38bdf8 59%,
        /* 60‚Äì100: –±–∏—Ä—é–∑–æ–≤—ã–π */
        #38bdf8 60%,
        #22d3ee 80%,
        #06b6d4 100%
      );
      -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='white'/%3E%3Cpath d='M50,2 A48,48 0 1,1 50,2 Z' fill='black'/%3E%3C/svg%3E") center/contain no-repeat;
      mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='white'/%3E%3Cpath d='M50,2 A48,48 0 1,1 50,2 Z' fill='black'/%3E%3C/svg%3E") center/contain no-repeat;
    }
    .circle-bg {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: var(--subtle);
      z-index: -1;
    }
    .indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      box-shadow:
        0 2px 6px rgba(0,0,0,0.12),
        0 0 0 4px var(--bg),
        0 0 0 6px rgba(147, 197, 253, 0.5);
      z-index: 2;
      pointer-events: none;
    }
    .center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 1;
    }
    .emoji { font-size: 52px; line-height: 1; }
    .value { font-size: 16px; font-weight: 500; margin-top: 6px; opacity: 0.7; }
    button {
      background: linear-gradient(135deg, #8b5cf6, #06b6d4);
      color: white;
      border: none;
      border-radius: 14px;
      padding: 16px 32px;
      font-size: 17px;
      font-weight: 600;
      margin-top: 20px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.25);
      transition: all 0.2s;
    }
    button:active { transform: scale(0.98); }
    .status { margin-top: 18px; font-size: 15px; color: var(--hint); text-align: center; }
  </style>
</head>
<body>
  <div class="title">–ö–∞–∫ —Ç—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å?</div>

  <div class="mood-circle">
    <div class="circle-bg"></div>
    <div class="circle-container">
      <div class="circle-fill" id="circleFill"></div>
    </div>
    <div class="indicator" id="indicator"></div>
    <div class="center">
      <div class="emoji" id="emoji">üôÇ</div>
      <div class="value" id="value">50</div>
    </div>
  </div>

  <button id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <div class="status" id="status"></div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) tg.expand(), tg.ready();

    const indicator = document.getElementById('indicator');
    const emojiEl = document.getElementById('emoji');
    const valueEl = document.getElementById('value');
    const saveBtn = document.getElementById('saveBtn');
    const statusEl = document.getElementById('status');
    const circleFill = document.getElementById('circleFill');

    let moodValue = 50;
    const RADIUS = 88;

    function updateUI() {
      // –£–≥–æ–ª: 0 = –≤–≤–µ—Ä—Ö—É, —Ä–∞—Å—Ç—ë—Ç –ø–æ —á–∞—Å–æ–≤–æ–π ‚Üí 0¬∞‚Äì360¬∞
      const angleDeg = (moodValue / 100) * 360;
      const angleRad = (angleDeg - 90) * Math.PI / 180; // -90 –¥–ª—è —Å–º–µ—â–µ–Ω–∏—è: 0¬∞ = –≤–≤–µ—Ä—Ö

      // –ü–æ–∑–∏—Ü–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
      const x = RADIUS * Math.cos(angleRad);
      const y = RADIUS * Math.sin(angleRad);
      indicator.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;

      // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Å–∫—É: –æ—Ç 0¬∞ –¥–æ angleDeg ‚Äî –≤–∏–¥–∏–º–æ
      const largeArc = angleDeg > 180 ? 1 : 0;
      const endX = 50 + 48 * Math.cos(angleDeg * Math.PI / 180);
      const endY = 50 - 48 * Math.sin(angleDeg * Math.PI / 180);

      const maskSVG = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="48" fill="white"/>
          <path d="M50,2 A48,48 0 ${largeArc},1 ${endX},${endY} Z" fill="black"/>
        </svg>
      `.replace(/\s+/g, ' ');

      const url = `data:image/svg+xml,${encodeURIComponent(maskSVG)}`;
      circleFill.style.mask = `url("${url}") center/contain no-repeat`;
      circleFill.style.webkitMask = `url("${url}") center/contain no-repeat`;

      // –°–º–∞–π–ª–∏–∫
      if (moodValue <= 19) emojiEl.textContent = 'üòû';
      else if (moodValue <= 39) emojiEl.textContent = 'üôÅ';
      else if (moodValue <= 59) emojiEl.textContent = 'üôÇ';
      else if (moodValue <= 79) emojiEl.textContent = 'üòÑ';
      else emojiEl.textContent = 'üòä';

      valueEl.textContent = moodValue;
    }

    function getAngleFromTouch(clientX, clientY) {
      const circle = document.querySelector('.mood-circle');
      const rect = circle.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      const dx = clientX - centerX;
      const dy = clientY - centerY;
      let angle = Math.atan2(-dy, dx) * 180 / Math.PI + 90; // 0¬∞ = –≤–≤–µ—Ä—Ö
      if (angle < 0) angle += 360;
      return angle;
    }

    function handleMove(e) {
      e.preventDefault();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      const angle = getAngleFromTouch(clientX, clientY);
      moodValue = Math.round((angle / 360) * 100);
      if (moodValue > 100) moodValue = 100;
      if (moodValue < 0) moodValue = 0;
      updateUI();
    }

    document.querySelector('.mood-circle').addEventListener('mousedown', (e) => {
      document.addEventListener('mousemove', handleMove);
      document.addEventListener('mouseup', () => {
        document.removeEventListener('mousemove', handleMove);
      }, { once: true });
      handleMove(e);
    });

    document.querySelector('.mood-circle').addEventListener('touchstart', (e) => {
      document.addEventListener('touchmove', handleMove, { passive: false });
      document.addEventListener('touchend', () => {
        document.removeEventListener('touchmove', handleMove);
      }, { once: true });
      handleMove(e);
    });

    saveBtn.addEventListener('click', () => {
      const entries = JSON.parse(localStorage.getItem('mood_entries') || '[]');
      entries.push({
        date: new Date().toISOString().split('T')[0],
        mood: moodValue,
        timestamp: Date.now()
      });
      localStorage.setItem('mood_entries', JSON.stringify(entries));
      tg?.sendData(JSON.stringify({ action: 'mood', mood: moodValue }));

      statusEl.textContent = '‚ú® –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
      saveBtn.disabled = true;
      setTimeout(() => {
        statusEl.textContent = '';
        saveBtn.disabled = false;
      }, 1500);
    });

    updateUI();
  </script>
</body>
</html>

